# -*- coding:utf-8 -*-
from VolatilityData_readpkl import *
from SVI_Calibration_Optimization_Util import *
import math
import matplotlib.pyplot as plt
import datetime
import operator
from mpl_toolkits.axes_grid1 import host_subplot
import mpl_toolkits.axisartist as AA
import plot_util as pu
from SVI_Calibration_Util import *
from matplotlib.patches import Rectangle

dates =  [datetime.date(2015, 3, 11), datetime.date(2015, 3, 18), datetime.date(2015, 3, 25), datetime.date(2015, 4, 1), datetime.date(2015, 4, 8), datetime.date(2015, 4, 15), datetime.date(2015, 4, 22), datetime.date(2015, 5, 6), datetime.date(2015, 5, 13), datetime.date(2015, 5, 20), datetime.date(2015, 5, 27), datetime.date(2015, 6, 3), datetime.date(2015, 6, 10), datetime.date(2015, 6, 17), datetime.date(2015, 6, 24), datetime.date(2015, 7, 1), datetime.date(2015, 7, 8), datetime.date(2015, 7, 15), datetime.date(2015, 7, 22), datetime.date(2015, 8, 5), datetime.date(2015, 8, 12), datetime.date(2015, 8, 19), datetime.date(2015, 8, 26), datetime.date(2015, 9, 2), datetime.date(2015, 9, 9), datetime.date(2015, 9, 16), datetime.date(2015, 9, 23), datetime.date(2015, 10, 8), datetime.date(2015, 10, 15), datetime.date(2015, 11, 5), datetime.date(2015, 11, 12), datetime.date(2015, 11, 19), datetime.date(2015, 12, 3), datetime.date(2015, 12, 10), datetime.date(2015, 12, 17), datetime.date(2016, 1, 7), datetime.date(2016, 1, 14), datetime.date(2016, 1, 21), datetime.date(2016, 2, 4), datetime.date(2016, 2, 15), datetime.date(2016, 2, 22), datetime.date(2016, 3, 7), datetime.date(2016, 3, 14), datetime.date(2016, 3, 21), datetime.date(2016, 4, 5), datetime.date(2016, 4, 12), datetime.date(2016, 4, 19), datetime.date(2016, 4, 26), datetime.date(2016, 5, 3), datetime.date(2016, 5, 10), datetime.date(2016, 5, 17), datetime.date(2016, 5, 24), datetime.date(2016, 6, 7), datetime.date(2016, 6, 14), datetime.date(2016, 6, 21), datetime.date(2016, 7, 5), datetime.date(2016, 7, 12), datetime.date(2016, 7, 19), datetime.date(2016, 7, 26), datetime.date(2016, 8, 2), datetime.date(2016, 8, 9), datetime.date(2016, 8, 16), datetime.date(2016, 8, 23), datetime.date(2016, 9, 6), datetime.date(2016, 9, 13), datetime.date(2016, 9, 20), datetime.date(2016, 9, 27), datetime.date(2016, 10, 10), datetime.date(2016, 10, 17), datetime.date(2016, 10, 24), datetime.date(2016, 11, 7), datetime.date(2016, 11, 14), datetime.date(2016, 11, 21), datetime.date(2016, 12, 5), datetime.date(2016, 12, 12), datetime.date(2016, 12, 19), datetime.date(2016, 12, 26), datetime.date(2017, 1, 3), datetime.date(2017, 1, 10), datetime.date(2017, 1, 17), datetime.date(2017, 1, 24), datetime.date(2017, 2, 3), datetime.date(2017, 2, 10), datetime.date(2017, 2, 17), datetime.date(2017, 3, 3), datetime.date(2017, 3, 10), datetime.date(2017, 3, 17), datetime.date(2017, 4, 7), datetime.date(2017, 4, 14), datetime.date(2017, 4, 21), datetime.date(2017, 5, 5), datetime.date(2017, 5, 12), datetime.date(2017, 5, 19), datetime.date(2017, 6, 2), datetime.date(2017, 6, 9), datetime.date(2017, 6, 16), datetime.date(2017, 6, 23), datetime.date(2017, 7, 7), datetime.date(2017, 7, 14)]
spread_this_month   =  [0.30802400520197604, 0.6362465039558417, -0.33899111948384764, 0.380407846860783, 0.47258977208253, 0.732330622950662, -0.8758490651017118, 0.3345063634685523, 0.4004035633553534, 0.5645381538454931, -0.6390727043912271, 0.39845704606617127, 0.5008914091235059, 0.611131939405795, -0.13969031870112944, 0.3641296479697344, -0.20506787644294378, 0.187988409308488, 0.5045015387098133, 0.16683926000187904, 0.32094363484964356, 0.3952028359976596, 0.8962927163711749, -0.9526018799239896, 0.23640339849775868, 0.435103318431958, 0.32449969887930985, 0.2188975588553398, 0.31952500561112646, 0.15417276716921138, 0.374411897107853, 0.49051193418438266, 0.23435607584660179, 0.38179432380999956, 0.609871194544425, 0.2384602345402555, 0.38312061816925086, 0.4532971044248226, 0.22151740650338742, 0.3671931147221845, 0.7842030714614241, 0.23426840615812075, 0.38789687235623777, 0.9748280045014109, 0.280647058119479, 0.36078513026109094, 0.45067761086027114, 1.0905648125288492, 0.23525819163747066, 0.2630139561604395, 0.3072844940469849, 0.7086760049055474, 0.3154455305855643, 0.3713120557713687, 1.157853422577419, 0.21783733459090227, 0.33565002783896625, 0.3759082270057391, 1.2057025165485424, 0.24112335983180944, 0.2735745876849005, 0.4276163959137983, 1.2333171759848613, 0.3405865511220713, 0.3350064871306649, 0.4306431413833859, 0.867765979955968, 0.2623848026063304, 0.28136109689749383, 0.8106340967463993, 0.26341300569381704, 0.3698201468182222, 0.8193929054194673, -0.06981884663218621, -0.09063175116150458, -0.11219919065321554, -0.20157349682353348, -0.00956362624513823, -0.03228189301890084, -0.006052088603387302, -0.17049226440373774, 0.010850309379646456, -0.05975438180712321, 0.07528365744438369, -0.05300425308319085, -0.05914458393311956, -0.08229858668626507, -0.06989014409688231, -2.8015138967687826e-05, -0.04114843698184845, -0.05516474196687549, -0.10403626596519669, -0.07865979792072197, -0.07199327067700534, -0.0788989443294124, -0.0670105908453427, -0.13993939751576656, -0.06070674494443849, -0.13152338212308431]
spread_next_month   =  [0.18377526902738103, 0.1875629753082079, 0.278528708132767, 0.13132214842396173, 0.15331491540074166, 0.2269440571914336, 0.22432701169247746, 0.21818430565699934, 0.2548509763258034, 0.3419594214564742, 0.33516239391231184, 0.24703216496177718, 0.2748205553981502, 0.3412220193897905, 0.41281567313337203, 0.2743143657111023, 0.1372837963221099, 0.020429428688951822, -0.0652197674155657, 0.00993874049860994, 0.17664309513265788, -0.14159884750981133, -0.3733546149578435, -0.6733100388436869, -0.06368337509177797, -0.011680116026416446, 0.06252447664712071, 0.056938944878590164, 0.10122595839898882, 0.07389460730989642, 0.2434109146074396, 0.19164794322637108, 0.0402249457274492, 0.04696556205318977, 0.11342006653831756, -0.10601242118817597, 0.1189682472590731, -0.003502807289944387, 0.09676648349245283, 0.1430826800576602, 0.09781321556263625, 0.0006499696290062828, 0.0459035798602475, 0.14755465218213654, 0.10631683942624577, 0.16192678845842087, 0.18477553644947597, 0.1602560246021011, 0.1749802724788247, 0.1515369791880942, 0.16704586466893426, 0.2002947048104636, 0.15840614916048854, 0.1320181155648454, 0.15882324065629413, 0.13000937560968695, 0.16696312384953152, 0.20470617145485662, 0.2204574062895259, 0.18315968124367107, 0.17324823251384175, 0.23692522794107002, 0.24393829894205793, 0.17054263968802247, 0.173016394445851, 0.18401401723253338, 0.1958639122523527, 0.1677201749881531, 0.15924931991184033, 0.19373226177165268, -0.08986920349370098, -0.12003931824683765, -0.13485376914485195, -0.02940183025564268, -0.04439731962528505, -0.055089430445676976, -0.05578699901739621, -0.025082008101890277, -0.021184141229467296, -0.04730397440640087, -0.021844722365932157, 0.0013368223928356781, -0.07141085289294831, -0.05034239819141973, -0.02657512215131838, -0.044925078299126106, -0.04632659131926148, -0.05827101283805002, -0.024050367595674048, -0.05302390745346544, -0.0517464953247531, -0.09067532301221815, -0.047328247679781735, -0.05516013315197072, -0.0375009209561442, -0.038565747967839244, -0.07337204407181135, -0.035533617834661385, -0.06183217666397686]
spread_this_season  =  [0.08831245637481924, 0.028420415805643293, 0.09923033037006479, 0.14594734253303177, 0.1564841120229059, 0.30480240412218906, 0.15609448875805118, 0.17412086829587975, 0.19550488870200575, 0.22220663221592837, 0.2450038453874637, 0.20701670887149798, 0.27929746706984515, 0.24823814297875993, 0.25882741733722187, 0.34421250720917523, 0.24798395107684312, 0.1821490589415887, -0.14653979820045335, -0.06828001238148251, 0.0061642099224390335, -0.13823672499254694, -0.14011410022509835, -0.5594089971055551, -0.11961162967508583, -0.20341288938009044, -0.036699622713047844, 0.07634771657539559, 0.168058286056801, -0.0965913004021409, 0.11177481096360668, 0.02640811527479562, 0.026407594016990412, 0.030654952361580112, 0.054824256926180544, -0.03925375472963193, 0.015987791714857046, -0.14441542401864935, -0.08540116058012637, -0.07477647920959554, -0.12532409625321903, -0.15355458747846418, -0.07786984449263722, 0.024178446719770708, 0.06319587873790185, 0.11326163490869556, 0.17214921482551804, 0.0985759593173217, 0.007300745321357508, 0.0012715694573129637, -0.019805644278325443, -0.008822022204667499, 0.06745275254397552, 0.02188346866947822, 0.01787995093592669, 0.07780531225205191, 0.12117885722596883, 0.1482373748652172, 0.17085301760685057, -0.08890285228160594, -0.07579923813131453, -0.015160166881213766, -0.0655356814713671, -0.05843123219715529, -0.059264292978414526, -0.08480366647245365, -0.07182552474467654, -0.0937843613717924, -0.09146844586756264, -0.09715548001019725, -0.09965030624506001, -0.11435571655010981, -0.12115807720662843, -0.06875252799296903, -0.09477624941002032, -0.07969031410654599, -0.10133222692172544, -0.06229988122961874, -0.049081489420534474, -0.0852608022003925, -0.04562114101023325, -0.02821570031685641, -0.04906904155236749, -0.039642175348902554, -0.03337751567894918, -0.05214933361434889, -0.06493394257085698, -0.07418345747194256, -0.045241020075173, -0.0687019401718548, -0.06399094494356863, -0.08254381061359191, -0.06349498070497107, -0.06313046753057105, -0.07665306600540735, -0.06929917565503887, -0.08418173993505428, -0.0883587107020484, -0.10367978753500236]
spread_next_season  =  [0.060208496019501644, -0.00038732386803011753, 0.0646054143403539, 0.10487474579428209, 0.10216167663189375, 0.18632641585590617, 0.1101378535545827, 0.13547681699792224, 0.14394993615977167, 0.19005384498245906, 0.1940469389812337, 0.17191779246666303, 0.20944044894965297, 0.1942688943317865, 0.16284243995539224, 0.26397370403240605, 0.3163110844302821, 0.12716968896630385, -0.07451629270207374, -0.017799796433153662, 0.01643106051258167, -0.09234075476813015, -0.07600374825842025, -0.3772740643943918, -0.13025305681906774, -0.14755537160237672, -0.03306337593238117, -0.027295027379621344, 0.023932320999778527, -0.07398242626729046, 0.060503450647251725, -0.016459282945465087, -0.015108879557851047, -0.0344273269757609, -0.03833573518544098, -0.09891099818641087, -0.10399670218927702, -0.168593354002456, -0.1254915318521079, -0.08710023088051405, -0.15401685236354415, -0.20804330491670647, -0.1451395277810012, -0.04174925268013801, -0.034619921228867895, -0.018049181753048312, 0.02373340879858758, -0.029430319720354266, -0.10281838716964964, -0.09779630949263654, -0.1349263211569483, -0.13324968424623926, -0.07838236402442639, -0.11083521307591568, -0.14920291981227457, -0.11884347885710245, -0.12383867753167242, -0.09497271239989007, -0.08070780813750571, -0.05534420154018095, -0.06166116184937928, -0.02271421413985016, -0.046731666870994795, -0.04182737372030984, -0.05203889279369381, -0.06703376948980483, -0.055234094554594264, -0.05546934169288951, -0.06746791112324112, -0.09428548807020551, -0.06571673916074128, -0.07187531721327113, -0.10230615406625598, -0.050704542532908924, -0.06436784097892348, -0.0633291430500946, -0.07638647950323554, -0.039189474130229114, -0.03904938229596695, -0.06720804509410663, -0.04374846652941351, -0.031947896953246346, -0.0382178125412267, -0.033920753284164246, -0.025682924274471348, -0.054036482649302504, -0.05161981789451476, -0.06695341435938376, -0.051828209694117, -0.0740937136684566, -0.073540579455934, -0.09405010367909014, -0.07355954993460476, -0.06785059085300181, -0.07749730833849565, -0.06230943183031716, -0.07780271752677902, -0.0790541828769462, -0.08769372950437257]
volum_next_month    =  [477.6571, 832.936, 1037.1582, 202.2685, 475.9393, 1908.0969, 2959.7076, 1873.9957, 1182.4237, 5186.5665, 5606.0909, 469.623, 969.8866, 2748.6106, 10321.1069, 636.9032, 1969.296, 4447.5216, 5499.1302, 1946.4218, 1743.7808, 8230.2067, 32540.5916, 3069.0025, 1569.336, 4114.441, 4895.4497, 718.347, 1300.5658, 5058.9046, 2430.4916, 4320.6825, 2079.1781, 1828.9523, 4752.552, 388.1586, 3196.2417, 5733.5707, 2684.7561, 3713.7036, 7988.8382, 1874.7817, 3522.3196, 9710.006, 1117.5851, 1296.6545, 1791.0684, 4590.3952, 3041.8879, 2925.5559, 2280.8043, 4615.4499, 998.9632, 3390.518, 6488.7693, 1493.1777, 3384.3396, 3729.6667, 7750.6556, 3173.9591, 3236.2563, 12634.3615, 10197.4407, 1977.5244, 2345.0993, 2047.5602, 6738.6761, 2503.4018, 3545.3455, 16552.0327, 3349.085, 17083.8846, 25358.9195, 5740.1588, 6967.9209, 6677.361, 13119.2081, 1920.3112, 2120.631, 4723.5837, 4155.7503, 6298.2486, 10806.4426, 14642.6331, 2823.9141, 2864.5052, 10591.8589, 2988.5987, 4750.5575, 8457.0537, 7351.1853, 11106.9962, 5468.0936, 5610.8036, 8265.4885, 4801.0661, 16532.5258, 3305.2426, 13356.3634]
callvol_next_month  =  [0.3197445645966569, 0.41757595026427663, 0.45721603549506884, 0.3774469912977993, 0.4586658438495757, 0.5505145714772782, 0.6009974261558144, 0.5696079727021914, 0.575454794520341, 0.5977541552622054, 0.6768866038558079, 0.5949064904004004, 0.6638393986552124, 0.6329889863128226, 0.6854336106683132, 0.7435505519205523, 0.6965311390627926, 0.5051902067580273, 0.3281281397152046, 0.4357723024699917, 0.46226524131022034, 0.34606794882151054, 0.6612176073378706, 0.19302755379274728, 0.4078526567091224, 0.4174482786226909, 0.4130923076521207, 0.32506485203646746, 0.3485193678911612, 0.3437982430631268, 0.4713307294278613, 0.4043195466402238, 0.31570337849671004, 0.330892773620579, 0.3455452636131434, 0.36174266766868624, 0.41232761957374525, 0.3682245085498497, 0.36157614015835854, 0.39270436255275204, 0.31600805094452106, 0.3168169355353969, 0.3467624518407464, 0.40782230023016425, 0.3552965016466277, 0.31424462335020326, 0.31581727686224836, 0.30000476488464184, 0.29759176620317285, 0.2635841674798799, 0.2527383454845969, 0.25026840151596885, 0.24509949603334957, 0.23637825151254882, 0.2259198535355709, 0.21651308742563283, 0.2677147926087857, 0.27139969773550254, 0.2842574144425065, 0.29389044245811213, 0.270948779226877, 0.32603820341201056, 0.32738690211707333, 0.24711844739069694, 0.21278609780299657, 0.20867902265284632, 0.215341412435505, 0.2204626266905711, 0.1963223902391084, 0.2602118333416695, 0.0956337670272043, 0.0623377517291436, 0.04238418874096059, 0.15751360132930842, 0.13671466338878138, 0.15248572418996076, 0.15062233491270896, 0.14786119878047704, 0.12653264244191972, 0.0870520202167219, 0.09417842218237568, 0.13194561453253256, 0.07475483283931962, 0.08235239896003756, 0.10143506309441773, 0.07821965975109979, 0.07430305193425232, 0.054828722918321665, 0.08530446951697279, 0.0632280342317616, 0.06527999215555039, 0.030904098083335545, 0.053524878259625736, 0.08682005309399554, 0.126829276600772, 0.10701316264189371, 0.0871713902183236, 0.11568044241870275, 0.11530761288867937]
putvol_next_month   =  [0.13596929556927592, 0.23001297495606884, 0.17868732736230186, 0.24612484287383754, 0.3053509284488341, 0.32357051428584455, 0.37667041446333693, 0.3514236670451921, 0.32060381819453765, 0.25579473380573126, 0.3417242099434961, 0.34787432543862334, 0.3890188432570622, 0.2917669669230321, 0.2726179375349411, 0.46923618620945, 0.5592473427406827, 0.48476077806907536, 0.3933479071307703, 0.4258335619713817, 0.2856221461775625, 0.4876667963313218, 1.0345722222957139, 0.8663375926364343, 0.47153603180090037, 0.42912839464910735, 0.35056783100500005, 0.26812590715787726, 0.24729340949217246, 0.26990363575323045, 0.22791981482042187, 0.21267160341385266, 0.2754784327692608, 0.2839272115673892, 0.23212519707482593, 0.46775508885686207, 0.29335937231467213, 0.3717273158397941, 0.2648096566659056, 0.24962168249509187, 0.2181948353818849, 0.3161669659063907, 0.30085887198049893, 0.2602676480480277, 0.2489796622203819, 0.15231783489178238, 0.1310417404127724, 0.1397487402825408, 0.12261149372434811, 0.11204718829178567, 0.08569248081566261, 0.0499736967055053, 0.08669334687286105, 0.1043601359477034, 0.06709661287927678, 0.08650371181594589, 0.10075166875925418, 0.06669352628064598, 0.06380000815298063, 0.11073076121444109, 0.09770054671303531, 0.08911297547094042, 0.0834486031750155, 0.07657580770267454, 0.03976970335714555, 0.02466500542031296, 0.019477500183152332, 0.05274245170241801, 0.03707307032726809, 0.06647957157001683, 0.1855029705209053, 0.18237706997598133, 0.17723795788581254, 0.1869154315849511, 0.18111198301406645, 0.2075751546356378, 0.2064093339301052, 0.17294320688236736, 0.14771678367138702, 0.13435599462312275, 0.11602314454830784, 0.1306087921396969, 0.14616568573226796, 0.13269479715145724, 0.12801018524573612, 0.1231447380502259, 0.12062964325351377, 0.11309973575637168, 0.10935483711264683, 0.11625194168522703, 0.1170264874803035, 0.12157942109555371, 0.10085312593940746, 0.14198018624596626, 0.1643301975569162, 0.14557891060973294, 0.16054343429013496, 0.15121406025336415, 0.17713978955265625]
underlying_close    =  [2.3228528158563764, 2.5547467153331924, 2.547897528428814, 2.693687363964871, 2.835563378412712, 2.9461288241548225, 3.17117353672726, 3.016577603742716, 3.0175560590147703, 2.9999438641177965, 3.2142255686976395, 3.122250773124556, 3.2484715032195317, 3.1065954887716907, 2.952978011059201, 2.6692259821635194, 2.547897528428814, 2.689773542876655, 2.678032079612006, 2.4373320826867033, 2.5087593175466507, 2.3747109452752424, 1.9040739594172316, 2.187825988312914, 2.1614076959674535, 2.193696719945238, 2.1330324930778857, 2.1486877774307507, 2.2543609468125907, 2.3923231401722154, 2.4167845219735677, 2.4177629772456215, 2.4069999692530266, 2.3042621656873488, 2.349271108201836, 2.130097127261723, 2.0850881847472356, 1.9989841208064771, 1.935384528122962, 1.907009325233394, 2.009747128799072, 2.0655190793061546, 2.0312731447842616, 2.1447739563425343, 2.128140216717615, 2.0958511927398304, 2.114441842908858, 2.1056357454603716, 2.1124849323647497, 2.025402413151937, 2.0322516000563158, 2.024423957879883, 2.0968296480118847, 2.0557345265856135, 2.0664975345782084, 2.137924769438156, 2.1848906224967517, 2.1682568828718325, 2.179019890864427, 2.1428170457984264, 2.1731491592321026, 2.256317857356699, 2.2406625730038336, 2.2367487519156177, 2.193696719945238, 2.190761354129076, 2.1809768014085353, 2.2132658253863196, 2.201524362121671, 2.273930052253672, 2.279800783885997, 2.3228528158563764, 2.3385081002092414, 2.373, 2.386, 2.293, 2.298, 2.307, 2.313, 2.329, 2.354, 2.342, 2.366, 2.361, 2.343, 2.335, 2.343, 2.384, 2.35, 2.341, 2.313, 2.37, 2.355, 2.47, 2.517, 2.46, 2.543, 2.561, 2.665]
volum_next_month    =  np.divide( volum_next_month, 100)

f, axarr = plt.subplots(4, sharex=True)


axarr[0].set_title('Underlying v.s. CPIV')
line1, = axarr[0].stackplot(dates, underlying_close,color = pu.c3)
line2, = axarr[1].plot(dates, spread_next_month, color = pu.c1,linestyle = pu.l1,linewidth = 2,label="Spread next month")
line3, = axarr[1].plot(dates, spread_this_season,color = pu.c2,linestyle = pu.l2,linewidth = 2,label = "Spread this season")
line4, = axarr[1].plot(dates, spread_next_season,color = pu.c3,linestyle = pu.l3,linewidth = 2,label="Spread next season")
line6, = axarr[2].plot(dates, callvol_next_month,color = pu.c4,linestyle = pu.l4,linewidth = 2,label="Call IV next month")
line7, = axarr[2].plot(dates, putvol_next_month,color = pu.c5,linestyle = pu.l5,linewidth = 2,label="Put IV next month")
line6.set_dashes(pu.dash)
axarr[3].bar(dates,volum_next_month,6,color = pu.c6)

axarr[0].set_ylim(min(underlying_close),max(underlying_close))
axarr[0].legend(['50 ETF'],loc = 0)
axarr[1].legend(loc = 0)
axarr[2].legend(loc = 0)
axarr[3].legend(['Volume (million)'],loc = 0)
#axarr[0].legend(line1,"50ETF")
axarr[1].grid()
axarr[0].grid()
axarr[2].grid()
plt.draw()
plt.show()
